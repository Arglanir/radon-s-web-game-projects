<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<!--
Age of paramecia 2
jeu créé par Cédric Mayer

jeu.html : contient une interface de jeu javascript, crée le jeu chez le client et le laisse 

jouer
	communique avec ajax avec jeu.php
	paramètres GET :
		j	nom du joueur courant
		p	numéro de la partie
		s	son
		pw	optionnel : mot de passe


********* Structure des données
tableauArguments : tableau des arguments de la page

-->
<html>
<head>
<title>AOP2</title>
<script type="text/javascript" src="ajax.js" ></script>
<script type="text/javascript">
/*** lecture des arguments de la page ***/
/*	paramètres GET :
		j	nom du joueur courant
		p	numéro de la partie
		s	son
		pw	optionnel : mot de passe
		offline	arrêt des communications avec le serveur (peut être mis en route en cours de jeu) */
var bouh = location.search.substring(1,location.search.length).split(unescape("%26"));//on enlève le ? et on sépare avec les &
var tableauArguments = new Array();
tableauArguments["offline"] = 0;
for (i=0;i<bouh.length;i++){
   var temp = bouh[i].split("=");
    tableauArguments[temp[0]]=unescape(temp[1]);
}
tableauArguments["offline"] = parseInt(tableauArguments["offline"]);
if (tableauArguments["j"] != "observateur")
	tableauArguments["j"] = parseInt(tableauArguments["j"]);

/*** initialisation des paramètres et types ***/
//les options d'affichage
var tempsEntreAffichages = 1000;
var tempsDAttenteAvantRelance = 5000;



var jeuTest="2\n1\nCédric 0000FF\nSara FFFF00\nn 0 0\nn 3 3";
jeuTest += "\n1\n9\n1\n1\n0";//chateauxactivés profondeur bordbloqués diagonale tempspasreel
jeuTest += "\n4\n4\n";
jeuTest += "0 0 0 0\n";
jeuTest += "0 0 0 0\n";
jeuTest += "0 0 0 0\n";
jeuTest += "0 0 0 0\n";

jeuTest += "0 0 0 0\n";
jeuTest += "10110 203 204 0\n";
jeuTest += "202 0 0 0\n";
jeuTest += "201 203 0 0\n1\n";


function CreerTableauJeu(chaineTexte){//constructeur d'un jeu
	var tabJeuT = chaineTexte.split("\n\r");
	tabJeuT = chaineTexte.split("\n");
	var indice = 0;
this.nbJoueurs = parseInt(tabJeuT[0]);
this.joueurEnCours = parseInt(tabJeuT[1]);
if (!this.joueurEnCours) alert("Mauvais chargement du jeu");
this.joueurs = new Array();
	for(var i=0;i<this.nbJoueurs;i++)
		this.joueurs[i+1] = tabJeuT[2+i].split("\t");//nom couleur motdepasse 1ia/2autreordi
		// /!\ le mot de passe des autres joueurs ne sera pas communiqué
	indice=2+this.nbJoueurs;
this.derniereAction = new Array();
	for(var i=0;i<this.nbJoueurs;i++)
		this.derniereAction[i+1] = tabJeuT[indice+i].split("\t");//action x y
	indice+=this.nbJoueurs;
this.options = new Array(); var nombreDOptions = 5;
	for(var i=0;i<nombreDOptions;i++)	//chateauxactivés profondeur bordbloqués diagonale tempspasreel
		this.options[i]=parseInt(tabJeuT[indice+i]);
	indice+=nombreDOptions;
this.tailleX = parseInt(tabJeuT[indice]);
this.tailleY = parseInt(tabJeuT[indice+1]);
	indice+=2;
this.tableauDecor = new Array();
	for(var i=0;i<this.tailleY;i++){
		this.tableauDecor[i]=tabJeuT[indice+i].split("\t");
		for(var j=0;j<this.tailleX;j++)
			this.tableauDecor[i][j]=parseInt(this.tableauDecor[i][j]);
	}
	indice+=this.tailleY;
this.tableauJeu = new Array();
	for(var i=0;i<this.tailleY;i++){
		this.tableauJeu[i]=tabJeuT[indice+i].split("\t");
		for(var j=0;j<this.tailleX;j++)
			this.tableauJeu[i][j]=parseInt(this.tableauJeu[i][j]);
	}
	indice+=this.tailleY;
this.noTour = parseInt(tabJeuT[indice++]);
this.tableauDesMax = new Array();//calcule le maximum de cellules dans les cases
	for(var i=0;i<this.tailleY;i++){
		this.tableauDesMax[i] = new Array();
		for(var j=0;j<this.tailleX;j++){
			var k = 4;
			if (this.options[2] == 1){//on compte les bords
					if (i==0 || i==this.tailleY-1)
						k--;
					if (j==0 || j==this.tailleX-1)
						k--;
			}
			for (var ii=-1;ii<2;ii++)//on regarde les obstacles
				for(var jj=-1;jj<2;jj++)
					if (Math.abs(ii)+Math.abs(jj)==1){//pas diagonale
						switch(this.options[2]){
						case 1: //on regarde pas après les bords
						case 0:
							if (entre(0,ii+i,this.tailleY-1)&&entre(0,jj+j,this.tailleX-1))
								if (this.tableauDecor[i+ii][j+jj]==3)
									k--;
							break;
						case 2://on regarde après le bord
							if (this.tableauDecor[mettreEntre(i+ii,this.tailleY)][mettreEntre(j+jj,this.tailleX)]==3)
								k--;
							break;
						}
					}
			this.tableauDesMax[i][j] = k;
		}
	}
	
//méthodes
this.purifie=purifie;
this.purifieEtAffiche=purifieEtAffiche;
this.affiche=affiche;
this.jouable=jouable;
this.toString=toString;
this.joueEn=joueEn;
this.chateauEn=chateauEn;
this.afficheOptions=afficheOptions;
this.existeGagnant=existeGagnant;
this.peutJouer=peutJouer;
this.lesJoueurs2string=lesJoueurs2string;
this.faireJouerSuivant=faireJouerSuivant;
}

function purifie(){with(this){//renvoie true s'il y a eu un changement, false sinon
		var changement=false;
		var ouGlaceExplosion = new Array();//var indiceGlace=0;//préparation des endroits glacés
		var differences = new Array(); //préparation du traitement des explosions
		var conquetes = new Array();
		for (var y=0;y<tailleY;y++){
			differences[y] = new Array();
			conquetes[y] = new Array();
			for (var x=0;x<tailleX;x++){
				differences[y][x] = 0;
				conquetes[y][x] = new Array();
			}
		}
		for (var x=0;x<tailleX;x++)  //traitement des explosions
			for(var y=0;y<tailleY;y++){
			  nbSurCase = this.tableauJeu[y][x];
			  if ((this.options[4] == 1 && case2joueur(nbSurCase)==this.joueurEnCours) || this.options[4] == 0)
				if (case2cellules(nbSurCase) >= this.tableauDesMax[y][x] && !case2chateau(nbSurCase)){//explosion !
	changement = true;
	for (var ii=-1;ii<2;ii++)//va sur les cases d'à côté
		for(var jj=-1;jj<2;jj++)
			if (Math.abs(ii)+Math.abs(jj)==1){//pas diagonale
				var nvx = x+jj; var nvy = y+ii;
				var perteBord = false;
				switch(this.options[2]){
				  case 2: //on regarde après les bords
					nvx = mettreEntre(x+jj,this.tailleX); nvy = mettreEntre(y+ii,this.tailleY);
				  case 0: perteBord=true; //on ne regarde pas au bord mais on perd une cellule
				  case 1: //on regarde pas après les bords
					if (entre(0,nvy,this.tailleY-1) && entre(0,nvx,this.tailleX-1)){
						switch(this.tableauDecor[nvy][nvx]){
						case 0: //case normale
							differences[y][x]--;
							if (case2chateau(this.tableauJeu[nvy][nvx])&&(case2joueur(nbSurCase)!=case2joueur(this.tableauJeu[nvy][nvx]))&&case2cellules(this.tableauJeu[nvy][nvx])>=10){//traitement si membrane adverse protgée
								differences[nvy][nvx]--;
							} else {//jeu normal ou destruction de la membrane et conquète des cellules
								//il va y avoir un bug si attaque et défense en même temps d'un chateau
								//on va dire que les attaquants ont toujours priorité... C'est un jeu !
								differences[nvy][nvx]++;
								if (case2chateau(this.tableauJeu[nvy][nvx])&&(case2joueur(nbSurCase)!=case2joueur(this.tableauJeu[nvy][nvx]))&&case2cellules(this.tableauJeu[nvy][nvx])<10)
									this.tableauJeu[nvy][nvx]-=(case2chateau(this.tableauJeu[nvy][nvx])?10000:0);
								conquetes[nvy][nvx][conquetes[nvy][nvx].length]=case2joueur(nbSurCase);
							}
							break;
						case 1: //glace
							differences[y][x]--;
							if (isNaN(ouGlaceExplosion[nvy+" "+nvx])){//1ere fois
								ouGlaceExplosion[nvy+" "+nvx] = 1;
							} else {//fois après
								//il va y avoir un BUG si 2 personnes tentent de conquérir une case de glace
								//c'est à cause du vent, il souffle pour favoriser les joueurs x plus grands puis y
								differences[nvy][nvx]++;
								conquetes[nvy][nvx][conquetes[nvy][nvx].length]=case2joueur(nbSurCase);
							}
							break;
						case 2: //point chaud
							differences[y][x]--;
							differences[nvy][nvx]+=2;
							conquetes[nvy][nvx][conquetes[nvy][nvx].length]=case2joueur(nbSurCase);
							break;
						case 3: //obstacle:rien !
							break;
						}
					  } else if (perteBord) {
						differences[y][x]--;
					  }
					break;
				}
			}

				}
		}
		
		for (var x=0;x<tailleX;x++)  //post traitement des explosions
			for(var y=0;y<tailleY;y++){
				var nbcellules = case2cellules(this.tableauJeu[y][x]);
				if (nbcellules + differences[y][x] < 0){
					alert("Valeur de case négative !");/*debug*/
					this.tableauJeu[y][x] = Math.floor(this.tableauJeu[y][x]/100)*100;
				} else if (nbcellules + differences[y][x] > 99) {
					this.tableauJeu[y][x] = Math.floor(this.tableauJeu[y][x]/100)*100+99;
				} else {
					this.tableauJeu[y][x] += differences[y][x];
				}
				if (conquetes[y][x].length > 1){ //qui gagne la case ?
					var gagnant = mettreEntre(x+this.tailleX*y, conquetes[y][x].length);
					this.tableauJeu[y][x] += conquetes[y][x][gagnant]*100-case2joueur(this.tableauJeu[y][x])*100;
				} else if (conquetes[y][x].length == 1){
					this.tableauJeu[y][x] += conquetes[y][x][0]*100-case2joueur(this.tableauJeu[y][x])*100;
				}
		}
		return changement;
}}

var enCoursDeTraitement = false;//pour ne pas accepter deux fois la même réponse
function purifieEtAffiche(profondeur){with(this){//fonction récursive pour purifier totalement et afficher
	enCoursDeTraitement = true;
	var profondeur = (profondeur == undefined?0:profondeur);
	if (profondeur>=this.options[1]){//fin de la purification
		this.joueurEnCours = mettreEntre(this.joueurEnCours,this.nbJoueurs)+1;//on passe au suivant
		if (this.joueurEnCours == 1) this.noTour++;//augmentation du n° du tour
		while(!this.peutJouer()) true;
		enCoursDeTraitement = false;
		this.affiche();
		this.faireJouerSuivant();
	} else {
		var changement = this.purifie();
		this.affiche(0);profondeur++;
		if (changement)//on arrête s'il y a pas de changements
			window.setTimeout("unJeu.purifieEtAffiche("+profondeur+")",tempsEntreAffichages);
		else
			this.purifieEtAffiche(this.options[1]);
	}
}}

function faireJouerSuivant(){with(this){//fait jouer les joueurs sur internet
	document.title = "AOP2 - "+this.joueurs[this.joueurEnCours][0];
	if (tableauArguments["offline"]==1 || this.joueurs[this.joueurEnCours][3] == 0){
		if (document.mdp.prevenu.checked) alert("C'est ton tour de jouer !");
		return;//c'est au joueur de jouer, on le laisse
	}
	document.getElementById("comm").innerHTML ="Demande de l'action du joueur "+this.joueurEnCours+" au serveur";
	ouJoue(this.joueurEnCours, function(tabReponse){
		if(tabReponse["n"] != unJeu.noTour){// && !enCoursDeTraitement)
			//on prévoit si la requete précédente est en cours de traitement
			document.getElementById("comm").innerHTML ="ReDemande de l'action du joueur "+unJeu.joueurEnCours+" au serveur";
			document.getElementById("comm").innerHTML += "<br />a="+tabReponse["a"]+" x="+tabReponse["x"]+" y="+tabReponse["y"]+" k="+tabReponse["k"]+" n="+tabReponse["n"]+" <br />";
			setTimeout("unJeu.faireJouerSuivant()",tempsDAttenteAvantRelance);//pas encore joué
		}else {
			document.getElementById("comm").innerHTML ="Traitement de l'action du joueur "+unJeu.joueurEnCours;
			document.getElementById("comm").innerHTML += "<br />a="+tabReponse["a"]+" x="+tabReponse["x"]+" y="+tabReponse["y"]+" k="+tabReponse["k"]+" n="+tabReponse["n"]+" <br />";

			if (tabReponse["a"]=="n")
				unJeu.joueEn(tabReponse["x"],tabReponse["y"]);
			else
				unJeu.chateauEn(tabReponse["x"],tabReponse["y"]);
		}
	});
}}

function lesJoueurs2string(){with(this){//renvoie un tableau de statistiques par joueur
	var statistiques = new Array();
	for (var n = 1; n<=this.nbJoueurs;n++){
		statistiques[n] = new Array();
		statistiques[n][0] = this.joueurs[n][1];//couleur
		statistiques[n][1] = this.joueurs[n][0];//nom
		statistiques[n][2] = (this.joueurs[n][3]!=undefined?this.joueurs[n][3]:0);//ia? autreordinateur?
		statistiques[n][3] = 0;//nombre de cellules
		statistiques[n][4] = 0;//cases controlées
		statistiques[n][5] = 0;//cases prêtes à exploser
		statistiques[n][6] = 0;//cases menacées (on compte plusieurs fois si plusieurs cases à exploser)
	}
		
	for (var x=0;x<this.tailleX;x++) for (var y=0;y<this.tailleY;y++){
			if (this.tableauDecor[y][x] == 3) continue;
			var quelJoueur = case2joueur(this.tableauJeu[y][x]);
			var nbcel = case2cellules(this.tableauJeu[y][x]);
			if (!quelJoueur || nbcel==0){//aucun joueur : on passe après avoir regardé les menaces
				var tabK = new Array();
				for (var ii=-1;ii<2;ii++)for(var jj=-1;jj<2;jj++){//va sur les cases d'à côté
					if (ii==0 && jj==0) continue;
					if (!this.options[3] && Math.abs(ii)+Math.abs(jj)!=1) continue;
					var nvx = x+jj; var nvy = y+ii;
					if(this.options[2]==2){//on regarde après les bords
						nvx = mettreEntre(x+jj,this.tailleX); nvy = mettreEntre(y+ii,this.tailleY);
					}
					if (entre(0,nvy,this.tailleY-1) && entre(0,nvx,this.tailleX-1)){
						var n = (case2cellules(this.tableauJeu[nvy][nvx])>0?case2joueur(this.tableauJeu[nvy][nvx]):0);
						if (n==0) continue;
						if (tabK[n]) continue;
						tabK[n] = 1;
						statistiques[n][6]++;
					}
				}
				continue;
			}
			statistiques[quelJoueur][3] += nbcel; //nombre de cellules
			statistiques[quelJoueur][4] += 1;//case controlée
			if (nbcel+1 >= this.tableauDesMax[y][x])
				statistiques[quelJoueur][5] += 1;//case prête à exploser
			//cases menacées autour
		for (var ii=-1;ii<2;ii++)for(var jj=-1;jj<2;jj++){//va sur les cases d'à côté
			if (ii==0 && jj==0) continue;
			var nvx = x+jj; var nvy = y+ii;
			if (this.options[2]==2){
				nvx = mettreEntre(x+jj,this.tailleX); nvy = mettreEntre(y+ii,this.tailleY);
			}
			if (entre(0,nvy,this.tailleY-1) && entre(0,nvx,this.tailleX-1))
				if (this.tableauDecor[nvy][nvx]!=3)
					if (case2joueur(this.tableauJeu[nvy][nvx]) != quelJoueur && Math.abs(ii)+Math.abs(jj)==1 && nbcel+1 >= this.tableauDesMax[y][x])
						statistiques[quelJoueur][6]++;//case pouvant être obtenue par explosion
		}

	}
	return statistiques;
}}

function peutJouer(quelJoueur){with(this){//vérifie si le joueur en cours peut jouer, sinon change de joueur
	var changerJoueur = (quelJoueur==undefined? true : false);//ne change que si c'est pas mis
	var quelJoueur = (quelJoueur==undefined || !quelJoueur? this.joueurEnCours : quelJoueur);
	for (var x=0;x<this.tailleX;x++)
		for (var y=0;y<this.tailleY;y++)
			if (case2joueur(this.tableauJeu[y][x])==quelJoueur && case2cellules(this.tableauJeu[y][x])>0)
				return true;
	if (changerJoueur){
		this.joueurEnCours = mettreEntre(this.joueurEnCours,this.nbJoueurs)+1;
		if (this.joueurEnCours == 1) this.noTour++;
	}
	return false;
}}

function existeGagnant(){with(this){//renvoie le numéro du joueur gagnant ! false sinon
	var leGagnant = 0;var nb = 0;
	for (var n = 1; n<=this.nbJoueurs;n++){
		if (this.peutJouer(n)){
			if (nb >=1) //déjà un !
				return false;
			nb++;
			leGagnant = n;
		}
	}
	return leGagnant;
}}

function affiche(typeJouable){with(this){//fonction qui affiche le jeu dans la fenêtre, jouable 0non/1oui/2chat
	//argument : 0 non jouable, 1 jouable, 2 chateau, 254 non jouable joueur externe 255 non jouable gagnant
	var nGagnant = this.existeGagnant();
	if (!tableauArguments["offline"] && this.joueurs[this.joueurEnCours][3] != 0) typeJouable = 254;//joueur ailleurs
	if (nGagnant) typeJouable = 255;
	var typeJouable = (typeJouable == undefined?1:typeJouable);
	var chaineHTML = "<table><tr><td><table cellpadding=\"0\" cellspacing=\"0\">";
	for(var y=0;y<this.tailleY;y++){
		chaineHTML += "<tr>";
		for(var x=0;x<this.tailleX;x++){
			var decor = this.tableauDecor[y][x];
			var joueur = case2joueur(this.tableauJeu[y][x]);
			var couleur = (joueur == 0 ? "BFBFBF" : this.joueurs[joueur][1]);
			if (decor==3) couleur = "000000";
			var cellules = case2cellules(this.tableauJeu[y][x]);
			if (cellules == 0 && joueur != 0){//éclaircir la couleur
				var coulvide = parseInt("FF",16);
				var tabCouleur;
				switch (couleur.substring(0,1)){
				case "#"://couleur #HHHHHH
					tabCouleur = new Array(parseInt(couleur.substring(1,3),16),parseInt(couleur.substring(3,5),16),parseInt(couleur.substring(5,7),16));break;
				case "r"://couleur rgb(rr,gg,bb)
					tabCouleur = couleur.split(",");
					tabCouleur = new Array(parseInt(couleur[0].split("(")[1]),parseInt(couleur[1],16),parseInt(couleur[2].split(")")[0]));break;
				default://couleur rgb(rr,gg,bb)
					tabCouleur = new Array(parseInt(couleur.substring(0,2),16),parseInt(couleur.substring(2,4),16),parseInt(couleur.substring(4,6),16));break;
				}
				tabCouleur[0] = Math.floor((tabCouleur[0]+coulvide)/2);
				tabCouleur[1] = Math.floor((tabCouleur[1]+coulvide)/2);
				tabCouleur[2] = Math.floor((tabCouleur[2]+coulvide)/2);
				couleur = "rgb("+tabCouleur[0]+","+tabCouleur[1]+","+tabCouleur[2]+")";
			}
			if (cellules >= this.tableauDesMax[y][x]){//Foncer la couleur
				var coulvide = parseInt("BF",16);
				var tabCouleur;
				switch (couleur.substring(0,1)){
				case "#"://couleur #HHHHHH
					tabCouleur = new Array(parseInt(couleur.substring(1,3),16),parseInt(couleur.substring(3,5),16),parseInt(couleur.substring(5,7),16));break;
				case "r"://couleur rgb(rr,gg,bb)
					tabCouleur = couleur.split(",");
					tabCouleur = new Array(parseInt(couleur[0].split("(")[1]),parseInt(couleur[1],16),parseInt(couleur[2].split(")")[0]));break;
				default://couleur rgb(rr,gg,bb)
					tabCouleur = new Array(parseInt(couleur.substring(0,2),16),parseInt(couleur.substring(2,4),16),parseInt(couleur.substring(4,6),16));break;
				}
				tabCouleur[0] = Math.floor((tabCouleur[0]+coulvide)/2);
				tabCouleur[1] = Math.floor((tabCouleur[1]+coulvide)/2);
				tabCouleur[2] = Math.floor((tabCouleur[2]+coulvide)/2);
				couleur = "rgb("+tabCouleur[0]+","+tabCouleur[1]+","+tabCouleur[2]+")";
			}
			chateau = case2chateau(this.tableauJeu[y][x]);
			
			chaineHTML += "<td style=\"";
			var leStyle = "align:center;";
			if (chateau){
				if (cellules<10)
					leStyle += "border-style:dotted;";
				else
					leStyle += "border-style:solid;";
				leStyle += "border-color:black;";
			} else {
				leStyle += "border-style:hidden;border-color:"+couleur+";";
			}
			if (decor == 1)
				leStyle += "text-decoration:line-through;";
			if (decor == 2)
				leStyle += "font-style: italic;";
			//chaineHTML += leStyle;
			chaineHTML += "\"><input id=\"c"+x+"_"+y+"\" title=\""+this.jouable(x,y)+"\" type=\"button\" style=\"";
			chaineHTML += "align:center;height:30px;width:30px;background-color:"+couleur+";";
			chaineHTML += leStyle + "\" ";
			chaineHTML += "value=\""+cellules+"\" ";
			switch(typeJouable){
				case 0:
					chaineHTML += "onclick=\"alert('Pause')\"";
					break;
				case 254:
					chaineHTML += "onclick=\"alert('Attente de "+this.joueurs[this.joueurEnCours][0]+"')\"";
					break;
				case 255:
					if (nGagnant == tableauArguments["j"])
						chaineHTML += "onclick=\"alert('Tu es le meilleur, bravo !')\"";
					else
						chaineHTML += "onclick=\"alert('Tu as fait de ton mieux, bravo !')\"";
					break;
				case 1:
					chaineHTML += "onclick=\"unJeu.joueEn("+x+","+y+")\"";
					break;
				case 2:
					chaineHTML += "onclick=\"unJeu.chateauEn("+x+","+y+")\"";
			}
			chaineHTML += "/></td>";
		}
		chaineHTML += "</tr>";
	}
	chaineHTML += "</table></td><td>";
	
	var statistiques = this.lesJoueurs2string();
	for (var n = 1; n<=this.nbJoueurs;n++){
		chaineHTML += "<p style=\"background-color:"+statistiques[n][0]+"\">";
		chaineHTML += (tableauArguments["j"] == n?"<b>":"");
		chaineHTML += (this.joueurEnCours == n?"&gt;":"");
		chaineHTML += statistiques[n][1]+"";//nom
		if (statistiques[n][2]>0)//joueur spécial
			chaineHTML += (statistiques[n][2]==1?" (IA)":" (NET)");
		chaineHTML += (tableauArguments["j"] == n?"</b>":"");
		//chaineHTML += (this.joueurEnCours == n?"</u>":"");
		chaineHTML += " <span title='Nombre de cellules'>"+statistiques[n][3]+"</span> ";
		chaineHTML += "<span title='Cases contrôlées'>"+statistiques[n][4]+"</span> ";
		chaineHTML += "<span title='Cases prêtes à exploser'>"+statistiques[n][5]+"</span> ";
		chaineHTML += "<span title='Cases menacées'>"+statistiques[n][6]+"</span>";
		chaineHTML += "</p>";
	}
	
	chaineHTML += "</td></tr></table><br />";
	switch (typeJouable){
		case 1:
			if (this.options[0]) {
				chaineHTML += "<input type='button' style='background-color:"+this.joueurs[this.joueurEnCours][1]+"' value='Mode : Ajout de cellule' onclick='unJeu.affiche(2)' title='' />";
				break;
			}
		case 2:
			if (this.options[0]) {
				chaineHTML += "<input type='button' style='background-color:"+this.joueurs[this.joueurEnCours][1]+"' value='Mode : Construire/détruire un chateau' onclick='unJeu.affiche(1)' title='' />";
				break;
			}
			chaineHTML += "<input type='button' style='background-color:"+this.joueurs[this.joueurEnCours][1]+"' value='Jouez...' title='' />";
			break;
		case 0:
			chaineHTML += "<input type='button' style='background-color:"+this.joueurs[this.joueurEnCours][1]+"' value='Patientez pendant le traitement...' onclick=\"alert('Pause')\" title='' />";
			break;
		case 255:
			chaineHTML += "<input type='button' style='background-color:"+this.joueurs[nGagnant][1]+"' value='"+this.joueurs[nGagnant][0]+" a gagné !' onclick=\"alert('Bravo !')\" title='' />";
			if (nGagnant == tableauArguments["j"]){
				setTimeout("document.getElementById(\"comm\").innerHTML = \"<input type=\\\"button\\\" onclick=\\\"supprimerPartie()\\\" value=\\\"Supprimer la partie\\\" />\";",10000);
			}
			break;
		case 254:
			chaineHTML += "<input type='button' style='background-color:"+this.joueurs[this.joueurEnCours][1]+"' value='Patientez pendant que "+this.joueurs[this.joueurEnCours][0]+" joue...' onclick=\"alert('Pause')\" title='' />";
			break;
		default:
			alert("Argument de affiche() non reconnu : "+typeJouable);
	}
		
	document.getElementById("jeu").innerHTML = chaineHTML;
	
	//traitement des dernières actions
	for (j=1; j<= this.nbJoueurs; j++)
		document.getElementById("c"+this.derniereAction[j][1]+"_"+this.derniereAction[j][2]).style.textDecoration = "underline";
	
}}

function toString(){with(this){//recrée une string de jeu
	var chaine = ""+this.nbJoueurs+"\n";
	chaine += this.joueurEnCours+"\n";
	for(var i=0;i<this.nbJoueurs;i++)
		for(var j=0;j<this.joueurs[i+1].length;j++)
			chaine += this.joueurs[i+1][j] +(j+1==this.joueurs[i+1].length?"\n":"\t");
	for(var i=0;i<this.nbJoueurs;i++)
		for(var j=0;j<this.derniereAction[i+1].length;j++)
			chaine += this.derniereAction[i+1][j] +(j+1==this.derniereAction[i+1].length?"\n":"\t");
	var nombreDOptions = 5;
	for(var i=0;i<nombreDOptions;i++)	//chateauxactivés profondeur bordbloqués diagonale tempspasreel
		chaine += this.options[i]+"\n";
	chaine += this.tailleX + "\n";
	chaine += this.tailleY + "\n";
	for(var i=0;i<this.tailleY;i++)
		for(var j=0;j<this.tailleX;j++)
			chaine += this.tableauDecor[i][j] +(j+1==this.tailleX?"\n":"\t");
	for(var i=0;i<this.tailleY;i++)
		for(var j=0;j<this.tailleX;j++)
			chaine += this.tableauJeu[i][j] +(j+1==this.tailleX?"\n":"\t");
	chaine += this.noTour+"\n";
	for(var i=0;i<this.tailleY;i++)
		for(var j=0;j<this.tailleX;j++)
			chaine += this.tableauDesMax[i][j] +(j+1==this.tailleX?"\n":"\t");
	return chaine;
}}

function joueEn(x,y){with(this){//ajoute une cellule du joueur en cours en x,y
	if (!this.jouable(x,y))
		return false;
	if (tableauArguments["offline"]==0 && this.joueurEnCours==tableauArguments["j"])
		jeJoueEn(x,y,false);//on n'attend pas de savoir si c'est bon, ce client est bien programmé
	if (case2cellules(this.tableauJeu[y][x]) >= 100 - (this.tableauDecor[y][x]==2?2:1))
		this.tableauJeu[y][x] = Math.floor(this.tableauJeu[y][x]/100)*100+99;//il a trop de cellules déjà
	else
		this.tableauJeu[y][x] += (this.tableauDecor[y][x]==2?2:1);
	this.tableauJeu[y][x] += this.joueurEnCours*100-case2joueur(this.tableauJeu[y][x])*100;
	this.derniereAction[this.joueurEnCours][0] = "n";
	this.derniereAction[this.joueurEnCours][1] = x;
	this.derniereAction[this.joueurEnCours][2] = y;
	this.derniereAction[this.joueurEnCours][3] = this.noTour;
	affiche(0);
	window.setTimeout("unJeu.purifieEtAffiche()",tempsEntreAffichages);
	return true;
}}

function chateauEn(x,y){with(this){//ajoute une cellule du joueur en cours en x,y et y crée une membrane
	if (this.tableauDecor[y][x] != 0 || this.options[0] == 0)//on ne peut construire de membrane que sur un endroit stable
		return false;
	if (!this.jouable(x,y))
		return false;
	if (tableauArguments["offline"]==0 && this.joueurEnCours==tableauArguments["j"])
		jeJoueEn(x,y,true);//on n'attend pas de savoir si c'est bon, ce client est bien programmé
	if (case2cellules(this.tableauJeu[y][x]) >= 99)
		this.tableauJeu[y][x] = Math.floor(this.tableauJeu[y][x]/100)*100+99;//il a trop de cellules déjà
	else
		this.tableauJeu[y][x] += 1;
	this.tableauJeu[y][x] += this.joueurEnCours*100-case2joueur(this.tableauJeu[y][x])*100;
	if (case2chateau(this.tableauJeu[y][x]))
		this.tableauJeu[y][x] -= 10000;//destruction d'un chateau
	else
		this.tableauJeu[y][x] += 10000;//construction d'un chateau
	this.derniereAction[this.joueurEnCours][0] = "c";
	this.derniereAction[this.joueurEnCours][1] = x;
	this.derniereAction[this.joueurEnCours][2] = y;
	this.derniereAction[this.joueurEnCours][3] = this.noTour;
	affiche(0);
	window.setTimeout("unJeu.purifieEtAffiche()",tempsEntreAffichages);
	return true;
}}

function jouable(x,y){with(this){//vérifie si le joueur en cours peut jouer en x,y
	if (case2joueur(this.tableauJeu[y][x]) != this.joueurEnCours && case2cellules(this.tableauJeu[y][x]) > 0)
		return false; //case déjà controlée par joueur adverse
	if (case2joueur(this.tableauJeu[y][x]) == this.joueurEnCours && case2cellules(this.tableauJeu[y][x]) > 0)
		if (this.tableauDecor[y][x] == 1 && case2cellules(this.tableauJeu[y][x]) >= this.tableauDesMax[y][x] - 1) //case déjà controlée par ce joueur
			return false // mais glace et limite atteinte
		else
			return true; // pas de problème
	if (this.tableauDecor[y][x] == 3)//obstacle
		return false;
	for(var i=-1;i<2;i++)//on va regarder si une case autour appartient au joueur
		for(var j=-1;j<2;j++){// 2 bordbloqués  3 diagonale
			if (i==0 && j==0)
				continue; // on a déjà testé la case centrale
			if (this.options[3] == 0 && Math.abs(i)+Math.abs(j)==2)
				continue;//pas en diagonale
			var nvx = x+i; var nvy = y+j;
			if (this.options[2] != 2 && (!entre(0,nvx,this.tailleX-1) || !entre(0,nvy,this.tailleY-1)))
				continue;//après le bord
			nvx = mettreEntre(nvx,this.tailleX);//au cas où le monde est rond
			nvy = mettreEntre(nvy,this.tailleY);
			if (case2joueur(this.tableauJeu[nvy][nvx]) == this.joueurEnCours && case2cellules(this.tableauJeu[nvy][nvx]) > 0)
				return true; //case controlée par ce joueur
	}
	return false;
}}

function afficheOptions(){with(this){//affiche les options en cours, pour faire connaître les règles
//chateauxactivés profondeur bordbloqués diagonale tempspasreel
	var chaineHTML = "";
	chaineHTML += (this.options[0]?"Chateaux permis":"Chateaux non permis")+"<br />";
	chaineHTML += "Profondeur de développement : "+this.options[1]+"<br />";
	switch(this.options[2]){
		case 0: chaineHTML += "Cellules perdues aux bords<br />";
			break;
		case 1: chaineHTML += "Bords solides<br />";
			break;
		case 2: chaineHTML += "Monde torrique<br />";
			break;
	}
	chaineHTML += (this.options[3]?"Placement autour des cases à soi":"Placement sur cases adjacentes en croix")+"<br />";
	chaineHTML += (this.options[4]?"Développement unique du joueur en cours":"Développement de tout le monde")+"<br />";
	
	document.getElementById("options").innerHTML = chaineHTML;
}}

//fonctions utiles
function case2chateau(entier){//regarde si sur une case il y a un chateau
	return (entier>=10000);
}

function case2cellules(entier){//retourne le nombre de cellules dans la case
	return (entier-(Math.floor(entier/100)*100));
}

function case2joueur(entier){//retourne le n° d'un joueur à qui est la case
	/*if (case2cellules(entier) == 0)
		return 0; //renvoie 0 si aucune cellule*/
	return Math.floor((entier-(case2chateau(entier)?10000:0))/100);
}

function entre(avant,puis,ensuite){//renvoie vrai si ils sont dans l'ordre
	return (avant<=puis) && (puis<=ensuite);
}

function mettreEntre(nombre,base){//fonction permettant le modulo
	while(nombre < 0)
		nombre+=base;
	while(nombre >= base)
		nombre-=base;
	return nombre;
}



/**** fonctions de communication AJAX ****/
function getJeu(){//demande au serveur le jeu 
	var a="g";
	var xhr = createXHR();
	var chaineDAppel = "jeu.php?a=g&p="+tableauArguments["p"]+(tableauArguments["pw"]?"&pw="+tableauArguments["pw"]:"")+"&j="+tableauArguments["j"]+"&nocache=" + Math.random();
	xhr.onreadystatechange  = function(){ 
		if(xhr.readyState  == 4){
			if(xhr.status  == 200) {
				document.getElementById("jeu").innerHTML = "Jeu reçu, traitement en cours...";
				traiterJeu(xhr.responseText); 
			} else {
				document.getElementById("jeu").innerHTML = "Jeu non reçu, partie ou joueur inconnu ou mot de passe incorrect.";
			}
         }
    }; 
	document.getElementById("jeu").innerHTML = "Attente du serveur...";
	
	xhr.open("GET", chaineDAppel,  true); 
	xhr.send(null);
}
function traiterJeu(leJeuChaine){//fonction de traitement après getJeu()
	//document.getElementById('jeu').innerHTML = leJeuChaine.split('\n').join('<br/>');
	unJeu = new CreerTableauJeu(leJeuChaine);
	unJeu.affiche(1);
	unJeu.afficheOptions();
	unJeu.faireJouerSuivant();
}

function jeJoueEn(x,y,chateau,fonctionALancer){//dit au serveur où on joue, arrête le jeu si contraire au serveur
	var a=(chateau?"c":"n");
	var xhr = createXHR();
	var chaineDAppel = "jeu.php?a="+a+"&x="+x+(tableauArguments["pw"]?"&pw="+tableauArguments["pw"]:"")+"&y="+y+"&p="+tableauArguments["p"]+"&j="+tableauArguments["j"]+"&nocache=" + Math.random();
	xhr.onreadystatechange  = function(){ 
		if(xhr.readyState  == 4){
			if(xhr.status  == 200) {
				document.getElementById("comm").innerHTML = "Information reçue.";
				if (xhr.responseXML.getElementsByTagName("action").item(0).getAttribute("autorisee")!="oui"){
					alert("Action refusée par le serveur !");
				}
				if (fonctionALancer != undefined)
					fonctionALancer(xhr);
			} else {
				document.getElementById("comm").innerHTML = "Information non reçue.<br />";
				document.getElementById("comm").innerHTML += "Info envoyée :" + chaineDAppel;
				alert("Erreur");
			}
         }
    }; 
	document.getElementById("comm").innerHTML = "Attente du serveur...";
	
	xhr.open("GET", chaineDAppel,  true); 
	xhr.send(null);
}

function ouJoue(noJoueur, fonctionALancer){//demande au serveur qu'a joué le joueur no
	var xhr = createXHR();
	var chaineDAppel = "jeu.php?a=m&k="+noJoueur+"&p="+tableauArguments["p"]+(tableauArguments["pw"]?"&pw="+tableauArguments["pw"]:"")+"&j="+tableauArguments["j"]+"&nocache=" + Math.random();
	xhr.onreadystatechange  = function(){ 
		if(xhr.readyState  == 4){
			if(xhr.status  == 200) {
				traiterOuJoue(noJoueur,xhr.responseXML,fonctionALancer);
			} else {
				document.getElementById("comm").innerHTML = "Information non reçue.<br />";
				document.getElementById("comm").innerHTML += "Info envoyée :" + chaineDAppel;
			}
         }
    };
	
	xhr.open("GET", chaineDAppel,  true); 
	xhr.send(null);
}
function traiterOuJoue(noJoueur,reponse,fonctionALancer){//fonction de traitement après ouJoue()
	//si entre balises, utiliser .getElementsByTagName("laBalise")[0].childNodes[0].nodeValue
	var a = reponse.getElementsByTagName("a").item(0).getAttribute("valeur");
	var x = parseInt(reponse.getElementsByTagName("x").item(0).getAttribute("valeur"));
	var y = parseInt(reponse.getElementsByTagName("y").item(0).getAttribute("valeur"));
	var k = parseInt(reponse.getElementsByTagName("k").item(0).getAttribute("valeur"));
	var n = parseInt(reponse.getElementsByTagName("n").item(0).getAttribute("valeur"));
	var tabReponse = new Array();
	tabReponse["a"] = a;tabReponse["x"] = x;tabReponse["y"] = y;tabReponse["k"] = k;tabReponse["n"] = n;
	if (fonctionALancer != undefined)
		fonctionALancer(tabReponse);
}

function quiJoue(fonctionALancer){// demande au serveur qui est en train de jouer
	var xhr = createXHR();
	var chaineDAppel = "jeu.php?a=m&k=0&p="+tableauArguments["p"]+(tableauArguments["pw"]?"&pw="+tableauArguments["pw"]:"")+"&j="+tableauArguments["j"]+"&nocache=" + Math.random();
	xhr.onreadystatechange  = function(){ 
		if(xhr.readyState  == 4){
			if(xhr.status  == 200) {
				document.getElementById("comm").innerHTML = "Information reçue.";
				traiterQuiJoue(xhr.responseXML,fonctionALancer);
			} else {
				document.getElementById("comm").innerHTML = "Information non reçue.<br />";
				document.getElementById("comm").innerHTML += "Info envoyée :" + chaineDAppel;
			}
         }
    }; 
	document.getElementById("comm").innerHTML = "Attente du serveur...";
	
	xhr.open("GET", chaineDAppel,  true); 
	xhr.send(null);
	
}
function traiterQuiJoue(reponse,fonctionALancer){//fonction de traitement après quiJoue()
	//si entre balises, utiliser .getElementsByTagName("laBalise")[0].childNodes[0].nodeValue
	var k = parseInt(reponse.getElementsByTagName("k").item(0).getAttribute("valeur"));
	var n = parseInt(reponse.getElementsByTagName("n").item(0).getAttribute("valeur"));
	document.getElementById("comm").innerHTML += "<br />k="+k+" ";
	var tabReponse = new Array();
	tabReponse["k"] = k;tabReponse["n"] = n;
	if (fonctionALancer != undefined)
		fonctionALancer(tabReponse);
}

function changeMP(){//demande au serveur de changer le mot de passe
	var xhr = createXHR();
	var chaineDAppel = "jeu.php?a=nvp"+(tableauArguments["pw"]?"&pw="+tableauArguments["pw"]:"")+"&k="+escape(document.mdp.motdepasse.value)+"&p="+tableauArguments["p"]+"&j="+tableauArguments["j"]+"&nocache=" + Math.random();
	xhr.onreadystatechange  = function(){ 
		if(xhr.readyState  == 4){
			if(xhr.status  == 200) {
				window.location.replace("jeu.html?p="+tableauArguments["p"]+"&j="+tableauArguments["j"]+"&pw="+escape(document.mdp.motdepasse.value));
			} else {
				alert("Mot de passe non changé");
			}
         }
    }; 
	document.getElementById("comm").innerHTML = "Attente du serveur...";
	
	xhr.open("GET", chaineDAppel,  true); 
	xhr.send(null);
	
}
function chargeMP(){
	window.location.replace("jeu.html?pw="+escape(document.mdp.motdepasse.value)+"&p="+tableauArguments["p"]+"&j="+tableauArguments["j"]);
}

function supprimerPartie(){
	var xhr = createXHR();
	var chaineDAppel = "jeu.php?a=s"+(tableauArguments["pw"]?"&pw="+tableauArguments["pw"]:"")+"&p="+tableauArguments["p"]+"&j="+tableauArguments["j"]+"&nocache=" + Math.random();
	xhr.onreadystatechange  = function(){ 
		if(xhr.readyState  == 4){
			if(xhr.status  == 200) {
				document.getElementById("options").innerHTML = "Partie supprimée.<br />";
			} else {
			}
         }
    }; 
	document.getElementById("comm").innerHTML = "Attente du serveur...";
	
	xhr.open("GET", chaineDAppel, true); 
	xhr.send(null);
}


/*** fonction principale ***/
var unJeu;
function main(){
	if (!tableauArguments["p"]) return;//le jeu n'est pas chargé
	getJeu();
	if (tableauArguments["synchroserveur"])
		setInterval("getJeu()",7000);
	/*unJeu = new CreerTableauJeu(jeuTest);
	unJeu.affiche(1);
	unJeu.afficheOptions();
	unJeu.faireJouerSuivant();*/
	
}

/*** fonctions diverses ***/
function charge(){//charge les images
// A FAIRE après image.php
}


</script>
</head>
<body onload="main()">
<div name="Joueurs" id="joueurs">
<!--input type="button" onclick="main()" value="Démarrer" title="Cliquer" /-->
<!--input type="button" onclick="document.getElementById('jeu').innerHTML = unJeu.toString().split('\n').join('<br/>');" value="Afficher la chaine" title="Cliquer" /-->
<!--input type="button" onclick="getJeu()" value="Recharger le Jeu" title="Cliquer" />
<input type="button" onclick="ouJoue(1)" value="Où joue 1 ?"  title="Cliquer" />
<input type="button" onclick="ouJoue(2)" value="Où joue 2 ?"  title="Cliquer" />
<input type="button" onclick="quiJoue()" value="Qui joue ?"  title="Cliquer" />
<input type="button" onclick="affiche()" value="Afficher le jeu"  title="Cliquer" /-->
<form name="mdp"><input type="text" name="motdepasse" value="Mot de passe" onfocus="this.value='';" /><input type="button" onclick="chargeMP();" value="OK" title="cliquer ici pour charger le mot de passe" /><input type="button" onclick="changeMP();" value="Change" title="cliquer ici pour changer le mot de passe" /> | <input type="button" name="mettreoffline" value="Online/offline" title="Sortir" onclick="if (tableauArguments['offline'] == 0) window.location.replace(window.location.href+'&offline=1'); else window.location.replace(window.location.href.split('offline').join('rien'));" onmouseover="if (tableauArguments['offline'] == 0) {this.title='Actuellement : online'; this.value='Se mettre offline';} else {this.title='Actuellement : offline'; this.value='Recharger le jeu online';}" /> | <input type="checkbox" name="prevenu" /> Etre prévenu quand c'est notre tour </form>
</div>

<div name="Jeu" id="jeu">

</div>
<div name="Jeu" id="options">
<form method="GET">
Numéro partie : <input type="text" name="p" value="0000000" onfocus="if (this.value='0000000') this.value='';" /><br/>
Numéro du joueur : <select name="j"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select><br/>
<input type="submit" value="Chercher la partie" title="clique ici" />
</form>
</div>
<div name="imagespréchargées" id="imgs" style="visibility:hidden;">
cette section est invisible et sert à précharger les images
</div>

<script type="text/javascript"><!-- Debugage !
function debug(chaine){
	document.getElementById("debug").innerHTML += chaine+"<br />";
}
//-->
</script>
<div id="debug">

</div>
<div id="comm">

</div>
</body>
</html>